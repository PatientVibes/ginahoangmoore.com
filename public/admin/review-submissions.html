<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Submission Review - KC Food Security Hub Admin</title>

    <!-- Site CSS -->
    <link rel="stylesheet" href="/css/tokens.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* Admin-specific styles */
        .admin-header {
            background: linear-gradient(135deg, var(--color-gray-800) 0%, var(--color-gray-900) 100%);
            color: white;
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-xl);
        }

        .admin-header h1 {
            margin: 0;
            font-size: var(--font-size-2xl);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-box {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .stat-box .number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .stat-box.pending .number { color: var(--warning); }
        .stat-box.approved .number { color: var(--success); }
        .stat-box.rejected .number { color: var(--error); }

        .stat-box .label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .submissions-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .submission-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: var(--spacing-xl);
            border-left: 4px solid var(--warning);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--bg-light);
        }

        .submission-id {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .submission-date {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .org-name {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--text-primary);
            margin: var(--spacing-xs) 0;
        }

        .submission-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .detail-group {
            margin-bottom: var(--spacing-md);
        }

        .detail-label {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
        }

        .detail-value {
            color: var(--text-primary);
            word-break: break-word;
        }

        .detail-value a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-approve {
            background: var(--success);
            color: white;
        }

        .btn-approve:hover {
            background: #1B5E20;
        }

        .btn-reject {
            background: var(--error);
            color: white;
        }

        .btn-reject:hover {
            background: #B71C1C;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-edit:hover {
            background: #0D47A1;
        }

        .loading-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .loading-state .spinner {
            font-size: var(--font-size-3xl);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        .message {
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-success {
            background: #E8F5E9;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .message-error {
            background: #FFEBEE;
            color: var(--error);
            border-left: 4px solid var(--error);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: var(--spacing-lg);
        }

        .auto-refresh .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Password overlay */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .password-dialog {
            background: white;
            padding: var(--spacing-2xl);
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            box-shadow: var(--box-shadow-lg);
        }

        .password-dialog h2 {
            margin: 0 0 var(--spacing-md);
            color: var(--text-primary);
        }

        .password-dialog p {
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
        }

        .password-input {
            width: 100%;
            padding: var(--spacing-md);
            font-size: var(--font-size-base);
            border: 2px solid var(--bg-medium);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
        }

        .password-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .password-error {
            color: var(--error);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .submission-details {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .submission-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <!-- Password Overlay (shown on load) -->
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-dialog">
            <h2>Admin Access Required</h2>
            <p>Please enter the admin password to continue.</p>
            <form id="passwordForm">
                <input
                    type="password"
                    id="passwordInput"
                    class="password-input"
                    placeholder="Enter password"
                    autocomplete="off"
                    required
                />
                <button type="submit" class="btn btn-approve" style="width: 100%;">
                    Unlock
                </button>
                <div id="passwordError" class="password-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Main Admin Interface (hidden until authenticated) -->
    <div id="adminContent" style="display: none;">
        <!-- Admin Header -->
        <header class="admin-header">
            <div class="container">
                <h1>Resource Submission Review</h1>
                <p style="margin: var(--spacing-xs) 0 0; opacity: 0.9;">KC Food Security Hub - Admin Dashboard</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container" style="padding-bottom: var(--spacing-2xl);">
            <!-- Stats Dashboard -->
            <div class="admin-stats">
                <div class="stat-box pending">
                    <div class="number" id="statPending">-</div>
                    <div class="label">Pending Review</div>
                </div>
                <div class="stat-box approved">
                    <div class="number" id="statApproved">-</div>
                    <div class="label">Approved</div>
                </div>
                <div class="stat-box rejected">
                    <div class="number" id="statRejected">-</div>
                    <div class="label">Rejected</div>
                </div>
            </div>

            <!-- Messages -->
            <div id="messageContainer"></div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner">⏳</div>
                <p>Loading submissions...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="icon">✅</div>
                <h3>All Caught Up!</h3>
                <p>No pending submissions to review at this time.</p>
            </div>

            <!-- Submissions List -->
            <div id="submissionsList" class="submissions-list"></div>

            <!-- Auto-refresh indicator -->
            <div class="auto-refresh">
                <div class="indicator"></div>
                <span>Auto-refreshing every 30 seconds</span>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            PASSWORD: 'kcfood2025',
            MAX_ATTEMPTS: 3,
            REFRESH_INTERVAL: 30000, // 30 seconds
            API_BASE: '/api/submissions'
        };

        // State
        let loginAttempts = 0;
        let refreshTimer = null;
        let isAuthenticated = false;

        // Password Protection
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const password = input.value;

            if (password === CONFIG.PASSWORD) {
                // Store in sessionStorage
                sessionStorage.setItem('adminAuth', 'true');
                isAuthenticated = true;

                // Hide overlay, show content
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

                // Load submissions
                loadSubmissions();
                startAutoRefresh();
            } else {
                loginAttempts++;

                if (loginAttempts >= CONFIG.MAX_ATTEMPTS) {
                    error.textContent = 'Too many failed attempts. Redirecting...';
                    error.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    error.textContent = `Incorrect password. ${CONFIG.MAX_ATTEMPTS - loginAttempts} attempts remaining.`;
                    error.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            }
        });

        // Check if already authenticated
        if (sessionStorage.getItem('adminAuth') === 'true') {
            isAuthenticated = true;
            document.getElementById('passwordOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadSubmissions();
            startAutoRefresh();
        }

        // Message Display
        function showMessage(text, type = 'success') {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            container.appendChild(message);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 300);
            }, 5000);
        }

        // Load Submissions
        async function loadSubmissions() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const submissionsList = document.getElementById('submissionsList');

            try {
                loadingState.style.display = 'block';
                emptyState.style.display = 'none';

                // Fetch stats
                const statsResponse = await fetch(`${CONFIG.API_BASE}?stats=true`);
                if (!statsResponse.ok) throw new Error('Failed to fetch stats');
                const stats = await statsResponse.json();

                document.getElementById('statPending').textContent = stats.pending || 0;
                document.getElementById('statApproved').textContent = stats.approved || 0;
                document.getElementById('statRejected').textContent = stats.rejected || 0;

                // Fetch pending submissions
                const response = await fetch(`${CONFIG.API_BASE}?status=pending`);
                if (!response.ok) throw new Error('Failed to fetch submissions');

                const submissions = await response.json();

                loadingState.style.display = 'none';

                if (!submissions || submissions.length === 0) {
                    emptyState.style.display = 'block';
                    submissionsList.innerHTML = '';
                    return;
                }

                // Render submissions
                submissionsList.innerHTML = submissions.map(sub => renderSubmission(sub)).join('');

                // Attach event listeners
                attachActionListeners();

            } catch (error) {
                console.error('Error loading submissions:', error);
                loadingState.style.display = 'none';
                showMessage('Error loading submissions. Please refresh the page.', 'error');
            }
        }

        // Render Submission Card
        function renderSubmission(sub) {
            const submittedDate = new Date(sub.submitted_at || sub.created_at).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            return `
                <div class="submission-card" data-id="${sub.id}">
                    <div class="submission-header">
                        <div>
                            <div class="submission-id">ID #${sub.id}</div>
                            <div class="org-name">${escapeHtml(sub.organization_name || sub.name)}</div>
                        </div>
                        <div class="submission-date">${submittedDate}</div>
                    </div>

                    <div class="submission-details">
                        ${sub.contact_name ? `
                            <div class="detail-group">
                                <div class="detail-label">Contact Person</div>
                                <div class="detail-value">${escapeHtml(sub.contact_name)}</div>
                            </div>
                        ` : ''}

                        ${sub.phone || sub.phone_formatted ? `
                            <div class="detail-group">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">
                                    <a href="tel:${sub.phone || sub.phone_formatted}">${escapeHtml(sub.phone_formatted || sub.phone)}</a>
                                </div>
                            </div>
                        ` : ''}

                        ${sub.email ? `
                            <div class="detail-group">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">
                                    <a href="mailto:${sub.email}">${escapeHtml(sub.email)}</a>
                                </div>
                            </div>
                        ` : ''}

                        ${sub.website ? `
                            <div class="detail-group">
                                <div class="detail-label">Website</div>
                                <div class="detail-value">
                                    <a href="${sub.website}" target="_blank" rel="noopener">${escapeHtml(sub.website)}</a>
                                </div>
                            </div>
                        ` : ''}

                        ${sub.address || sub.city || sub.state || sub.zip ? `
                            <div class="detail-group">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">
                                    ${sub.address ? escapeHtml(sub.address) + '<br>' : ''}
                                    ${[sub.city, sub.state, sub.zip].filter(Boolean).join(', ')}
                                </div>
                            </div>
                        ` : ''}

                        ${sub.county ? `
                            <div class="detail-group">
                                <div class="detail-label">County</div>
                                <div class="detail-value">${escapeHtml(sub.county)}</div>
                            </div>
                        ` : ''}

                        ${sub.category || sub.category_name ? `
                            <div class="detail-group">
                                <div class="detail-label">Category</div>
                                <div class="detail-value">${escapeHtml(sub.category_name || sub.category)}</div>
                            </div>
                        ` : ''}

                        ${sub.description ? `
                            <div class="detail-group" style="grid-column: 1 / -1;">
                                <div class="detail-label">Description</div>
                                <div class="detail-value">${escapeHtml(sub.description)}</div>
                            </div>
                        ` : ''}

                        ${sub.services_provided ? `
                            <div class="detail-group" style="grid-column: 1 / -1;">
                                <div class="detail-label">Services Provided</div>
                                <div class="detail-value">${escapeHtml(sub.services_provided)}</div>
                            </div>
                        ` : ''}

                        ${sub.hours_of_operation ? `
                            <div class="detail-group" style="grid-column: 1 / -1;">
                                <div class="detail-label">Hours of Operation</div>
                                <div class="detail-value">${escapeHtml(sub.hours_of_operation)}</div>
                            </div>
                        ` : ''}

                        ${sub.eligibility_criteria ? `
                            <div class="detail-group" style="grid-column: 1 / -1;">
                                <div class="detail-label">Eligibility Criteria</div>
                                <div class="detail-value">${escapeHtml(sub.eligibility_criteria)}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-approve" data-action="approve" data-id="${sub.id}">
                            ✅ Approve
                        </button>
                        <button class="btn btn-reject" data-action="reject" data-id="${sub.id}">
                            ❌ Reject
                        </button>
                        <button class="btn btn-edit" data-action="edit" data-id="${sub.id}" disabled>
                            ✏️ Edit (Coming Soon)
                        </button>
                    </div>
                </div>
            `;
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Attach Action Listeners
        function attachActionListeners() {
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', handleAction);
            });
        }

        // Handle Actions
        async function handleAction(e) {
            const button = e.currentTarget;
            const action = button.dataset.action;
            const id = button.dataset.id;
            const card = button.closest('.submission-card');

            if (action === 'edit') {
                showMessage('Edit functionality coming soon!', 'error');
                return;
            }

            // Confirm action
            const confirmMsg = action === 'approve'
                ? 'Approve this submission and add to resources?'
                : 'Reject this submission?';

            if (!confirm(confirmMsg)) return;

            // Disable all buttons in card
            card.querySelectorAll('button').forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`${CONFIG.API_BASE}/${action}?id=${id}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Failed to ${action} submission`);
                }

                // Show success message
                showMessage(`Submission ${action}d successfully!`, 'success');

                // Animate card removal
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                card.style.transition = 'all 0.3s ease-out';

                setTimeout(() => {
                    card.remove();

                    // Check if list is empty
                    const remainingCards = document.querySelectorAll('.submission-card');
                    if (remainingCards.length === 0) {
                        document.getElementById('emptyState').style.display = 'block';
                    }

                    // Reload stats
                    loadSubmissions();
                }, 300);

            } catch (error) {
                console.error(`Error ${action}ing submission:`, error);
                showMessage(`Error ${action}ing submission. Please try again.`, 'error');

                // Re-enable buttons
                card.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }

        // Auto-refresh
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);

            refreshTimer = setInterval(() => {
                if (isAuthenticated) {
                    loadSubmissions();
                }
            }, CONFIG.REFRESH_INTERVAL);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshTimer) clearInterval(refreshTimer);
        });
    </script>
</body>
</html>
